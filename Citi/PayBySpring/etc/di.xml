<?xml version="1.0"?>
<!--
  ~ Copyright (c) 2020-2021 Citigroup
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
    <preference for="Citi\PayBySpring\Api\SessionInformationManagementInterface" type="Citi\PayBySpring\Model\SessionInformationManagement" />

    <virtualType name="CitiHpfLogger" type="Magento\Payment\Model\Method\Logger">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHostedLogger" type="Magento\Payment\Model\Method\Logger">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>

    <!-- Virtual operation classes that specify apiOperation generically -->
    <virtualType name="AuthorizeOperationDataBuilder" type="Citi\PayBySpring\Gateway\Request\OperationBuilder">
        <arguments>
            <argument name="operation" xsi:type="string">AUTHORIZE</argument>
        </arguments>
    </virtualType>
    <virtualType name="CreateSessionOperationDataBuilder" type="Citi\PayBySpring\Gateway\Request\OperationBuilder">
        <arguments>
            <argument name="operation" xsi:type="string">CREATE_CHECKOUT_SESSION</argument>
        </arguments>
    </virtualType>
    <virtualType name="CaptureOperationDataBuilder" type="Citi\PayBySpring\Gateway\Request\OperationBuilder">
        <arguments>
            <argument name="operation" xsi:type="string">CAPTURE</argument>
        </arguments>
    </virtualType>
    <virtualType name="SaleOperationDataBuilder" type="Citi\PayBySpring\Gateway\Request\OperationBuilder">
        <arguments>
            <argument name="operation" xsi:type="string">PAY</argument>
        </arguments>
    </virtualType>
    <virtualType name="RefundOperationDataBuilder" type="Citi\PayBySpring\Gateway\Request\OperationBuilder">
        <arguments>
            <argument name="operation" xsi:type="string">REFUND</argument>
        </arguments>
    </virtualType>
    <virtualType name="VoidOperationDataBuilder" type="Citi\PayBySpring\Gateway\Request\OperationBuilder">
        <arguments>
            <argument name="operation" xsi:type="string">VOID</argument>
        </arguments>
    </virtualType>
    <virtualType name="ThreeDSecureCheckOperationDataBuilder" type="Citi\PayBySpring\Gateway\Request\OperationBuilder">
        <arguments>
            <argument name="operation" xsi:type="string">CHECK_3DS_ENROLLMENT</argument>
        </arguments>
    </virtualType>
    <virtualType name="ThreeDSecureProcessOperationDataBuilder" type="Citi\PayBySpring\Gateway\Request\OperationBuilder">
        <arguments>
            <argument name="operation" xsi:type="string">PROCESS_ACS_RESULT</argument>
        </arguments>
    </virtualType>

    <virtualType name="InitiateAuthenticationOperationDataBuilder" type="Citi\PayBySpring\Gateway\Request\OperationBuilder">
        <arguments>
            <argument name="operation" xsi:type="string">INITIATE_AUTHENTICATION</argument>
        </arguments>
    </virtualType>
    <virtualType name="AuthenticatePayerOperationDataBuilder" type="Citi\PayBySpring\Gateway\Request\OperationBuilder">
        <arguments>
            <argument name="operation" xsi:type="string">AUTHENTICATE_PAYER</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfRestClient" type="Citi\PayBySpring\Gateway\Http\Client\Rest">
        <arguments>
            <argument name="logger" xsi:type="object">CitiHpfLogger</argument>
            <argument name="converter" xsi:type="object">Citi\PayBySpring\Gateway\Http\Converter\JsonToArray</argument>
            <argument name="adapter" xsi:type="object">Citi\PayBySpring\Gateway\Http\Client\Adapter\Rest</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHostedRestClient" type="Citi\PayBySpring\Gateway\Http\Client\Rest">
        <arguments>
            <argument name="logger" xsi:type="object">CitiHostedLogger</argument>
            <argument name="converter" xsi:type="object">Citi\PayBySpring\Gateway\Http\Converter\JsonToArray</argument>
            <argument name="adapter" xsi:type="object">Citi\PayBySpring\Gateway\Http\Client\Adapter\Rest</argument>
        </arguments>
    </virtualType>

    <!-- Check 3D-Secure enrollment -->
    <virtualType name="CitiHpfThreeDSecureEnrollmentCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiThreeDSecureDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHpfTransferFactoryEnrolment</argument>
            <argument name="client" xsi:type="object">CitiHpfRestClient</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ThreeDSecureValidator</argument>
            <argument name="handler" xsi:type="object">Citi\PayBySpring\Gateway\Response\ThreeDSecure\CheckHandler</argument>
        </arguments>
    </virtualType>

    <!-- Init Auth 3D-Secure 2 -->
    <virtualType name="CitiHpfThreeDSecure2InitiateAuthenticationCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiThreeDSecure2DataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHpfTransferFactoryInitiateAuthentication</argument>
            <argument name="client" xsi:type="object">CitiHpfRestClient</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\Authentication\InitiateAuthenticationValidator</argument>
            <argument name="handler" xsi:type="object">Citi\PayBySpring\Gateway\Response\Authentication\InitiateAuthenticationHandler</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfThreeDSecure2AuthenticatePayerCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiThreeDSecure2AuthenticatePayerDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHpfTransferFactoryInitiateAuthentication</argument>
            <argument name="client" xsi:type="object">CitiHpfRestClient</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\Authentication\AuthenticatePayerValidator</argument>
            <argument name="handler" xsi:type="object">Citi\PayBySpring\Gateway\Response\Authentication\AuthenticatePayerHandler</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfTransferFactoryInitiateAuthentication" type="Citi\PayBySpring\Gateway\Http\Authentication\TransferFactoryInitiateAuthentication">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfTransferFactoryEnrolment" type="Citi\PayBySpring\Gateway\Http\ThreeDSecure\TransferFactoryEnrolment">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiThreeDSecureDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">ThreeDSecureCheckOperationDataBuilder</item>
                <item name="3ds_check" xsi:type="string">Citi\PayBySpring\Gateway\Request\ThreeDSecure\CheckDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiThreeDSecure2DataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">InitiateAuthenticationOperationDataBuilder</item>
                <item name="session" xsi:type="string">Citi\PayBySpring\Gateway\Request\Authentication\SessionDataBuilder</item>
                <item name="order_currency" xsi:type="string">Citi\PayBySpring\Gateway\Request\Authentication\OrderCurrencyBuilder</item>
                <item name="authentication" xsi:type="string">Citi\PayBySpring\Gateway\Request\Authentication\AuthenticationBuilder</item>
                <item name="order_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\OrderReferenceDataBuilder</item>
                <item name="transaction_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\Authentication\InitAuthTransactionReferenceDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiThreeDSecure2AuthenticatePayerDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">AuthenticatePayerOperationDataBuilder</item>
                <item name="session" xsi:type="string">Citi\PayBySpring\Gateway\Request\Authentication\SessionDataBuilder</item>
                <item name="order_currency" xsi:type="string">Citi\PayBySpring\Gateway\Request\Authentication\OrderCurrencyBuilder</item>
                <item name="order_amount" xsi:type="string">Citi\PayBySpring\Gateway\Request\Authentication\OrderAmountBuilder</item>
                <item name="billing" xsi:type="string">Citi\PayBySpring\Gateway\Request\BillingDataBuilder</item>
                <item name="shipping" xsi:type="string">Citi\PayBySpring\Gateway\Request\ShippingDataBuilder</item>
                <item name="customer" xsi:type="string">Citi\PayBySpring\Gateway\Request\CustomerDataBuilder</item>
                <item name="device" xsi:type="string">Citi\PayBySpring\Gateway\Request\Authentication\DeviceBuilder</item>
                <item name="authentication" xsi:type="string">Citi\PayBySpring\Gateway\Request\Authentication\AuthenticatePayerBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiVoidDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">VoidOperationDataBuilder</item>
                <item name="void" xsi:type="string">Citi\PayBySpring\Gateway\Request\VoidDataBuilder</item>
                <item name="version" xsi:type="string">Citi\PayBySpring\Gateway\Request\VersionDataBuilder</item>
                <item name="transaction_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\TransactionReferenceDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiRefundDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">RefundOperationDataBuilder</item>
                <item name="refund" xsi:type="string">Citi\PayBySpring\Gateway\Request\TransactionDataBuilder</item>
                <item name="version" xsi:type="string">Citi\PayBySpring\Gateway\Request\VersionDataBuilder</item>
                <item name="transaction_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\TransactionReferenceDataBuilder</item>
                <item name="order_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\OrderReferenceDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiCaptureDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">CaptureOperationDataBuilder</item>
                <item name="capture" xsi:type="string">Citi\PayBySpring\Gateway\Request\TransactionDataBuilder</item>
                <item name="version" xsi:type="string">Citi\PayBySpring\Gateway\Request\VersionDataBuilder</item>
                <item name="order_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\OrderReferenceDataBuilder</item>
                <item name="transaction_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\TransactionReferenceDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="Citi3DSecureVerifyDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">ThreeDSecureProcessOperationDataBuilder</item>
                <item name="3ds_process" xsi:type="string">Citi\PayBySpring\Gateway\Request\ThreeDSecure\ProcessDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiAuthorizeResponseHandler" type="Magento\Payment\Gateway\Response\HandlerChain">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="transaction" xsi:type="string">Citi\PayBySpring\Gateway\Response\TransactionIdHandler</item>
                <item name="authorize" xsi:type="string">Citi\PayBySpring\Gateway\Response\AuthorizeHandler</item>
                <item name="payment" xsi:type="string">Citi\PayBySpring\Gateway\Response\PaymentHandler</item>
            </argument>
        </arguments>
    </virtualType>

    <type name="Citi\PayBySpring\Gateway\Command\UpdateOrderCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">Citi\PayBySpring\Gateway\Request\RequestParamsBuilder</argument>
            <argument name="transferFactory" xsi:type="object">Citi\PayBySpring\Gateway\Http\GetTransferFactory</argument>
            <argument name="handler" xsi:type="object">Citi\PayBySpring\Gateway\Response\UpdateOrderHandler</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </type>
    <virtualType name="HpfInformationTransferFactory" type="Citi\PayBySpring\Gateway\Http\InformationTransferFactory">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiCheckHpfGatewayCommand" type="Magento\Payment\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">Citi\PayBySpring\Gateway\Request\NullDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">HpfInformationTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHpfRestClient</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\PaymentOptionsInquiryValidator</argument>
        </arguments>
    </virtualType>
    <virtualType name="HostedInformationTransferFactory" type="Citi\PayBySpring\Gateway\Http\InformationTransferFactory">
        <arguments>
            <argument name="config" xsi:type="object">CitiHostedConfig</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiCheckHostedGatewayCommand" type="Magento\Payment\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">Citi\PayBySpring\Gateway\Request\NullDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">HostedInformationTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHostedRestClient</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\PaymentOptionsInquiryValidator</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfUpdateOrderCommand" type="Citi\PayBySpring\Gateway\Command\UpdateOrderCommand">
        <arguments>
            <argument name="transferFactory" xsi:type="object">CitiHpfGetTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHpfRestClient</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfGetTransferFactory" type="Citi\PayBySpring\Gateway\Http\GetTransferFactory">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHostedUpdateOrderCommand" type="Citi\PayBySpring\Gateway\Command\UpdateOrderCommand">
        <arguments>
            <argument name="transferFactory" xsi:type="object">CitiHostedGetTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHostedRestClient</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHostedGetTransferFactory" type="Citi\PayBySpring\Gateway\Http\GetTransferFactory">
        <arguments>
            <argument name="config" xsi:type="object">CitiHostedConfig</argument>
        </arguments>
    </virtualType>
    <type name="Citi\PayBySpring\Controller\Webhook\Response">
        <arguments>
            <argument name="commandPool" xsi:type="object">WebhookCommandPool</argument>
        </arguments>
    </type>
    <virtualType name="WebhookCommandPool" type="Magento\Payment\Gateway\Command\CommandPool">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="citi_hpf" xsi:type="string">CitiHpfUpdateOrderCommand</item>
                <item name="citi_hosted" xsi:type="string">CitiHostedUpdateOrderCommand</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="MetaCommandPool" type="Magento\Payment\Gateway\Command\CommandPool">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="check_gateway_citi_hpf" xsi:type="string">CitiCheckHpfGatewayCommand</item>
                <item name="check_gateway_citi_hosted" xsi:type="string">CitiCheckHostedGatewayCommand</item>
            </argument>
        </arguments>
    </virtualType>

    <type name="Magento\Payment\Gateway\Command\CommandManagerPool">
        <arguments>
            <argument name="executors" xsi:type="array">
                <item name="citi_hpf" xsi:type="string">CitiHpfCommandManager</item>
            </argument>
        </arguments>
    </type>

    <!-- *************** -->
    <!-- HOSTED CHECKOUT -->
    <!-- *************** -->
    <virtualType name="CitiHostedInfoBlock" type="Citi\PayBySpring\Block\Info">
        <arguments>
            <argument name="data" xsi:type="array">
                <item xsi:type="string" name="is_secure_mode">0</item>
            </argument>
            <argument name="config" xsi:type="object">CitiHostedConfig</argument>
        </arguments>
    </virtualType>

    <type name="Citi\PayBySpring\Model\SessionInformationManagement">
        <arguments>
            <argument name="commandPool" xsi:type="object">CitiHostedCommandPool</argument>
        </arguments>
    </type>

    <virtualType name="CitiHostedConfig" type="Citi\PayBySpring\Gateway\Config\Hosted\Config">
        <arguments>
            <argument name="methodCode" xsi:type="const">Citi\PayBySpring\Model\Ui\Hosted\ConfigProvider::METHOD_CODE</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHostedCommandPool" type="Magento\Payment\Gateway\Command\CommandPool">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="create_session" xsi:type="string">CitiHostedCreateSessionCommand</item>
                <item name="authorize" xsi:type="string">CitiHostedAuthorizeCommand</item>
                <item name="capture" xsi:type="string">CitiHostedCaptureStrategyCommand</item>
                <item name="capture_simple" xsi:type="string">CitiHostedPreAuthCaptureCommand</item>
                <item name="sale" xsi:type="string">CitiHostedSaleCommand</item>
                <item name="refund" xsi:type="string">CitiHostedRefundCommand</item>
                <item name="void" xsi:type="string">CitiHostedVoidCommand</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHostedFacade" type="Magento\Payment\Model\Method\Adapter">
        <arguments>
            <argument name="code" xsi:type="const">Citi\PayBySpring\Model\Ui\Hosted\ConfigProvider::METHOD_CODE</argument>
            <argument name="formBlockType" xsi:type="string">Magento\Payment\Block\Form\Cc</argument>
            <argument name="infoBlockType" xsi:type="string">CitiHostedInfoBlock</argument>
            <argument name="valueHandlerPool" xsi:type="object">CitiHostedValueHandlerPool</argument>
            <argument name="validatorPool" xsi:type="object">CitiHostedValidatorPool</argument>
            <argument name="commandPool" xsi:type="object">CitiHostedCommandPool</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHostedValidatorPool" type="Magento\Payment\Gateway\Validator\ValidatorPool">
        <arguments>
            <argument name="validators" xsi:type="array">
                <item name="country" xsi:type="string">CitiHostedCountryValidator</item>
                <item name="currency" xsi:type="string">CitiHostedCurrencyValidator</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHostedCurrencyValidator" type="Citi\PayBySpring\Gateway\Validator\CurrencyValidator">
        <arguments>
            <argument name="config" xsi:type="object">CitiHostedConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHostedCountryValidator" type="Magento\Payment\Gateway\Validator\CountryValidator">
        <arguments>
            <argument name="config" xsi:type="object">CitiHostedConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHostedConfigValueHandler" type="Magento\Payment\Gateway\Config\ConfigValueHandler">
        <arguments>
            <argument name="configInterface" xsi:type="object">CitiHostedConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHostedValueHandlerPool" type="Magento\Payment\Gateway\Config\ValueHandlerPool">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="default" xsi:type="string">CitiHostedConfigValueHandler</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Authorize -->
    <virtualType name="CitiHostedAuthorizeCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiHostedAuthorizeDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHostedTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHostedRestClient</argument>
            <argument name="handler" xsi:type="object">CitiAuthorizeResponseHandler</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHostedAuthorizeDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">AuthorizeOperationDataBuilder</item>
                <item name="session" xsi:type="string">Citi\PayBySpring\Gateway\Request\SessionDataBuilder</item>
                <item name="order" xsi:type="string">Citi\PayBySpring\Gateway\Request\OrderDataBuilder</item>
                <item name="line_items" xsi:type="string">Citi\PayBySpring\Gateway\Request\LineItemsBuilder</item>
                <item name="discount" xsi:type="string">Citi\PayBySpring\Gateway\Request\DiscountBuilder</item>
                <item name="billing" xsi:type="string">Citi\PayBySpring\Gateway\Request\BillingDataBuilder</item>
                <item name="shipping" xsi:type="string">Citi\PayBySpring\Gateway\Request\ShippingDataBuilder</item>
                <item name="customer" xsi:type="string">Citi\PayBySpring\Gateway\Request\CustomerDataBuilder</item>
                <item name="source" xsi:type="string">Citi\PayBySpring\Gateway\Request\SourceDataBuilder</item>
                <item name="version" xsi:type="string">Citi\PayBySpring\Gateway\Request\VersionDataBuilder</item>
                <item name="transaction_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\TransactionReferenceDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Purchase -->
    <virtualType name="CitiHostedSaleCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiHostedSaleDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHostedTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHostedRestClient</argument>
            <argument name="handler" xsi:type="object">CitiSaleResponseHandler</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHostedSaleDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">SaleOperationDataBuilder</item>
                <item name="card" xsi:type="string">Citi\PayBySpring\Gateway\Request\SessionDataBuilder</item>
                <item name="order" xsi:type="string">Citi\PayBySpring\Gateway\Request\OrderDataBuilder</item>
                <item name="line_items" xsi:type="string">Citi\PayBySpring\Gateway\Request\LineItemsBuilder</item>
                <item name="discount" xsi:type="string">Citi\PayBySpring\Gateway\Request\DiscountBuilder</item>
                <item name="billing" xsi:type="string">Citi\PayBySpring\Gateway\Request\BillingDataBuilder</item>
                <item name="shipping" xsi:type="string">Citi\PayBySpring\Gateway\Request\ShippingDataBuilder</item>
                <item name="customer" xsi:type="string">Citi\PayBySpring\Gateway\Request\CustomerDataBuilder</item>
                <item name="source" xsi:type="string">Citi\PayBySpring\Gateway\Request\SourceDataBuilder</item>
                <item name="version" xsi:type="string">Citi\PayBySpring\Gateway\Request\VersionDataBuilder</item>
                <item name="transaction_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\TransactionReferenceDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Capture -->
    <virtualType name="CitiHostedCaptureStrategyCommand" type="Citi\PayBySpring\Gateway\Command\Hosted\CaptureStrategyCommand">
        <arguments>
            <argument name="commandPool" xsi:type="object">CitiHostedCommandPool</argument>
            <argument name="config" xsi:type="object">CitiHostedConfig</argument>
        </arguments>
    </virtualType>

    <!-- Create a HC session -->
    <virtualType name="CitiHostedCreateSessionCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiHostedSessionDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">Citi\PayBySpring\Gateway\Http\Hosted\TransferFactorySession</argument>
            <argument name="client" xsi:type="object">CitiHostedRestClient</argument>
            <argument name="handler" xsi:type="object">Citi\PayBySpring\Gateway\Response\Hosted\SessionHandler</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Capture a pre-authorized payment (HC) -->
    <virtualType name="CitiHostedPreAuthCaptureCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiCaptureDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHostedTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHostedRestClient</argument>
            <argument name="handler" xsi:type="object">Citi\PayBySpring\Gateway\Response\TransactionIdHandler</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Refund (HC) -->
    <virtualType name="CitiHostedRefundCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiRefundDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHostedTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHostedRestClient</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Void (HC) -->
    <virtualType name="CitiHostedVoidCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiVoidDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHostedTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHostedRestClient</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <type name="Citi\PayBySpring\Gateway\Http\Hosted\TransferFactorySession">
        <arguments>
            <argument name="config" xsi:type="object">CitiHostedConfig</argument>
        </arguments>
    </type>

    <virtualType name="CitiHostedTransferFactory" type="Citi\PayBySpring\Gateway\Http\TransferFactory">
        <arguments>
            <argument name="config" xsi:type="object">CitiHostedConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHostedSessionDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">CreateSessionOperationDataBuilder</item>
                <item name="interaction" xsi:type="string">Citi\PayBySpring\Gateway\Request\Hosted\InteractionBuilder</item>
                <item name="order" xsi:type="string">Citi\PayBySpring\Gateway\Request\QuoteDataBuilder</item>
                <item name="billing" xsi:type="string">Citi\PayBySpring\Gateway\Request\BillingDataBuilder</item>
                <item name="shipping" xsi:type="string">Citi\PayBySpring\Gateway\Request\ShippingDataBuilder</item>
                <item name="customer" xsi:type="string">Citi\PayBySpring\Gateway\Request\CustomerDataBuilder</item>
                <item name="source" xsi:type="string">Citi\PayBySpring\Gateway\Request\SourceDataBuilder</item>
                <item name="references" xsi:type="string">Citi\PayBySpring\Gateway\Request\QuoteReferencesBuilder</item>
                <item name="version" xsi:type="string">Citi\PayBySpring\Gateway\Request\VersionDataBuilder</item>
                <item name="extra" xsi:type="string">CitiHostedCreateSessionExtraDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHostedCreateSessionExtraDataBuilder" type="Citi\PayBySpring\Gateway\Request\ExtraDataBuilder">
        <arguments>
            <argument name="config" xsi:type="object">CitiHostedConfig</argument>
            <argument name="field" xsi:type="string">custom_create_session_request_data</argument>
        </arguments>
    </virtualType>

    <!-- ******************* -->
    <!-- HOSTED PAYMENT FORM -->
    <!-- ******************* -->
    <virtualType name="CitiHpfCommandManager" type="Magento\Payment\Gateway\Command\CommandManager">
        <arguments>
            <argument name="commandPool" xsi:type="object">CitiHpfCommandPool</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfInfoBlock" type="Citi\PayBySpring\Block\Info">
        <arguments>
            <argument name="data" xsi:type="array">
                <item xsi:type="string" name="is_secure_mode">0</item>
            </argument>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfConfig" type="Citi\PayBySpring\Gateway\Config\Hpf\Config">
        <arguments>
            <argument name="methodCode" xsi:type="const">Citi\PayBySpring\Model\Ui\Hpf\ConfigProvider::METHOD_CODE</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfValueHandlerPool" type="Magento\Payment\Gateway\Config\ValueHandlerPool">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="default" xsi:type="string">CitiHpfConfigValueHandler</item>
            </argument>
        </arguments>
    </virtualType>
    <type name="Citi\PayBySpring\Gateway\Config\Is3DS2EnabledHandler">
        <arguments>
            <argument name="configInterface" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </type>
    <virtualType name="CitiHpfConfigValueHandler" type="Magento\Payment\Gateway\Config\ConfigValueHandler">
        <arguments>
            <argument name="configInterface" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfFacade" type="Magento\Payment\Model\Method\Adapter">
        <arguments>
            <argument name="code" xsi:type="const">Citi\PayBySpring\Model\Ui\Hpf\ConfigProvider::METHOD_CODE</argument>
            <argument name="formBlockType" xsi:type="string">Magento\Payment\Block\Form\Cc</argument>
            <argument name="infoBlockType" xsi:type="string">CitiHpfInfoBlock</argument>
            <argument name="valueHandlerPool" xsi:type="object">CitiHpfValueHandlerPool</argument>
            <argument name="validatorPool" xsi:type="object">CitiHpfValidatorPool</argument>
            <argument name="commandPool" xsi:type="object">CitiHpfCommandPool</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfValidatorPool" type="Magento\Payment\Gateway\Validator\ValidatorPool">
        <arguments>
            <argument name="validators" xsi:type="array">
                <item name="country" xsi:type="string">CitiHpfCountryValidator</item>
                <item name="currency" xsi:type="string">CitiHpfCurrencyValidator</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfCurrencyValidator" type="Citi\PayBySpring\Gateway\Validator\CurrencyValidator">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfCountryValidator" type="Magento\Payment\Gateway\Validator\CountryValidator">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfCommandPool" type="Magento\Payment\Gateway\Command\CommandPool">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="authorize" xsi:type="string">CitiHpfAuthorizeStrategyCommand</item>
                <item name="authorize_simple" xsi:type="string">CitiHpfAuthorizeCommand</item>
                <item name="3ds_process" xsi:type="string">CitiHpf3dsProcessCommand</item>
                <item name="capture" xsi:type="string">CitiHpfCaptureStrategyCommand</item>
                <item name="capture_simple" xsi:type="string">CitiHpfSaleStrategyCommand</item>
                <item name="sale" xsi:type="string">CitiHpfSaleCommand</item>
                <item name="pre_auth_capture" xsi:type="string">CitiHpfPreAuthCaptureCommand</item>
                <item name="refund" xsi:type="string">CitiHpfRefundCommand</item>
                <item name="void" xsi:type="string">CitiHpfVoidCommand</item>
                <item name="create_token" xsi:type="string">CitiHpfCreateTokenCommand</item>
                <item name="vault_sale" xsi:type="string">CitiHpfVaultSaleCommand</item>
                <item name="vault_authorize" xsi:type="string">CitiHpfVaultAuthorizeCommand</item>
                <item name="initiate_authentication" xsi:type="string">CitiHpfThreeDSecure2InitiateAuthenticationCommand</item>
                <item name="authenticate_payer" xsi:type="string">CitiHpfThreeDSecure2AuthenticatePayerCommand</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- HPF Vault -->
    <virtualType name="CitiHpfVaultFacade" type="Magento\Vault\Model\Method\Vault">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfVaultPaymentConfig</argument>
            <argument name="valueHandlerPool" xsi:type="object">CitiHpfVaultPaymentValueHandlerPool</argument>
            <argument name="vaultProvider" xsi:type="object">CitiHpfFacade</argument>
            <argument name="code" xsi:type="const">Citi\PayBySpring\Model\Ui\Hpf\ConfigProvider::CC_VAULT_CODE</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfVaultPaymentConfig" type="Magento\Payment\Gateway\Config\Config">
        <arguments>
            <argument name="methodCode" xsi:type="const">Citi\PayBySpring\Model\Ui\Hpf\ConfigProvider::CC_VAULT_CODE</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfVaultPaymentValueHandlerPool" type="VaultPaymentValueHandlerPool">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="default" xsi:type="string">CitiHpfVaultPaymentValueHandler</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfVaultPaymentValueHandler" type="VaultPaymentDefaultValueHandler">
        <arguments>
            <argument name="configInterface" xsi:type="object">CitiHpfVaultPaymentConfig</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfCreateTokenCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiHpfCreateTokenDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHpfTrasferFactoryCreateToken</argument>
            <argument name="client" xsi:type="object">CitiHpfRestClient</argument>
            <argument name="handler" xsi:type="object">CitiHpfTokenCreateHandler</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\TokenCreateValidator</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfCreateTokenDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="session" xsi:type="string">Citi\PayBySpring\Gateway\Request\Hpf\SessionDataBuilder</item>
                <item name="extra" xsi:type="string">CitiHpfCreateTokenExtraDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfCreateTokenExtraDataBuilder" type="Citi\PayBySpring\Gateway\Request\ExtraDataBuilder">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
            <argument name="field" xsi:type="string">custom_create_token_request_data</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfTrasferFactoryCreateToken" type="Citi\PayBySpring\Gateway\Http\Vault\TransferFactoryCreateToken">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfTokenCreateHandler" type="Citi\PayBySpring\Gateway\Response\TokenCreateHandler">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfVaultSaleCommand" type="CitiHpfSaleCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiHpfVaultSaleDataBuilder</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfVaultSaleDataBuilder" type="CitiHpfSaleDataBuilder">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="session" xsi:type="string">Citi\PayBySpring\Gateway\Request\Hpf\SessionDataBuilder</item>
                <item name="card" xsi:type="string">Citi\PayBySpring\Gateway\Request\TokenDataBuilder</item>
                <item name="version" xsi:type="string">Citi\PayBySpring\Gateway\Request\VersionDataBuilder</item>
                <item name="extra" xsi:type="string">CitiHpfSaleExtraDataBuilder</item>
                <item name="transaction_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\TransactionReferenceDataBuilder</item>
                <item name="order_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\OrderReferenceDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfVaultAuthorizeCommand" type="CitiHpfAuthorizeCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiHpfVaultAuthorizeDataBuilder</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfVaultAuthorizeDataBuilder" type="CitiHpfAuthorizeDataBuilder">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="session" xsi:type="string">Citi\PayBySpring\Gateway\Request\Hpf\SessionDataBuilder</item>
                <item name="card" xsi:type="string">Citi\PayBySpring\Gateway\Request\TokenDataBuilder</item>
                <item name="version" xsi:type="string">Citi\PayBySpring\Gateway\Request\VersionDataBuilder</item>
                <item name="extra" xsi:type="string">CitiHpfAuthorizeExtraDataBuilder</item>
                <item name="transaction_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\TransactionReferenceDataBuilder</item>
                <item name="order_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\OrderReferenceDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Void -->
    <virtualType name="CitiHpfVoidCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiVoidDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHpfTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHpfRestClient</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Refund -->
    <virtualType name="CitiHpfRefundCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiRefundDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHpfTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHpfRestClient</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Authorize + Capture command aka. Sale -->
    <virtualType name="CitiHpfSaleCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiHpfSaleDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHpfTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHpfRestClient</argument>
            <argument name="handler" xsi:type="object">CitiSaleResponseHandler</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiSaleResponseHandler" type="Magento\Payment\Gateway\Response\HandlerChain">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="transaction" xsi:type="string">Citi\PayBySpring\Gateway\Response\TransactionIdHandler</item>
                <item name="capture" xsi:type="string">Citi\PayBySpring\Gateway\Response\CaptureHandler</item>
                <item name="payment" xsi:type="string">Citi\PayBySpring\Gateway\Response\PaymentHandler</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfSaleDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">SaleOperationDataBuilder</item>
                <item name="card" xsi:type="string">Citi\PayBySpring\Gateway\Request\Hpf\SessionDataBuilder</item>
                <item name="order" xsi:type="string">Citi\PayBySpring\Gateway\Request\OrderDataBuilder</item>
                <item name="authentication_transaction_id" xsi:type="string">Citi\PayBySpring\Gateway\Request\Authentication\AuthenticationTransactionIdBuilder</item>
                <item name="line_items" xsi:type="string">Citi\PayBySpring\Gateway\Request\LineItemsBuilder</item>
                <item name="discount" xsi:type="string">Citi\PayBySpring\Gateway\Request\DiscountBuilder</item>
                <item name="billing" xsi:type="string">Citi\PayBySpring\Gateway\Request\BillingDataBuilder</item>
                <item name="shipping" xsi:type="string">Citi\PayBySpring\Gateway\Request\ShippingDataBuilder</item>
                <item name="customer" xsi:type="string">Citi\PayBySpring\Gateway\Request\CustomerDataBuilder</item>
                <item name="3ds_results" xsi:type="string">CitiHpfThreeDSecureResultDataBuilder</item>
                <item name="source" xsi:type="string">Citi\PayBySpring\Gateway\Request\SourceDataBuilder</item>
                <item name="version" xsi:type="string">Citi\PayBySpring\Gateway\Request\VersionDataBuilder</item>
                <item name="extra" xsi:type="string">CitiHpfSaleExtraDataBuilder</item>
                <item name="transaction_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\TransactionReferenceDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfSaleExtraDataBuilder" type="Citi\PayBySpring\Gateway\Request\ExtraDataBuilder">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
            <argument name="field" xsi:type="string">custom_sale_request_data</argument>
        </arguments>
    </virtualType>

    <!-- Capture a pre-authorized payment (HPF) -->
    <virtualType name="CitiHpfPreAuthCaptureCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiCaptureDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHpfTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHpfRestClient</argument>
            <argument name="handler" xsi:type="object">Citi\PayBySpring\Gateway\Response\TransactionIdHandler</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Capture -->
    <virtualType name="CitiHpfCaptureStrategyCommand" type="Citi\PayBySpring\Gateway\Command\VerificationStrategyCommand">
        <arguments>
            <argument name="commandPool" xsi:type="object">CitiHpfCommandPool</argument>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
            <argument name="successCommand" xsi:type="string">capture_simple</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfSaleStrategyCommand" type="Citi\PayBySpring\Gateway\Command\SaleStrategyCommand">
        <arguments>
            <argument name="commandPool" xsi:type="object">CitiHpfCommandPool</argument>
        </arguments>
    </virtualType>

    <!-- Authorize -->
    <virtualType name="CitiHpfAuthorizeStrategyCommand" type="Citi\PayBySpring\Gateway\Command\VerificationStrategyCommand">
        <arguments>
            <argument name="commandPool" xsi:type="object">CitiHpfCommandPool</argument>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
            <argument name="successCommand" xsi:type="string">authorize_simple</argument>
        </arguments>
    </virtualType>

    <!-- Pure authorize command -->
    <virtualType name="CitiHpfAuthorizeCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">CitiHpfAuthorizeDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHpfTransferFactory</argument>
            <argument name="client" xsi:type="object">CitiHpfRestClient</argument>
            <argument name="handler" xsi:type="object">CitiAuthorizeResponseHandler</argument>
            <argument name="validator" xsi:type="object">Citi\PayBySpring\Gateway\Validator\ResponseValidator</argument>
        </arguments>
    </virtualType>

    <!-- Verify 3D-Secure results -->
    <virtualType name="CitiHpf3dsProcessCommand" type="Citi\PayBySpring\Gateway\Command\GatewayCommand">
        <arguments>
            <argument name="requestBuilder" xsi:type="object">Citi3DSecureVerifyDataBuilder</argument>
            <argument name="transferFactory" xsi:type="object">CitiHpfTransferFactoryProcess</argument>
            <argument name="client" xsi:type="object">CitiHpfRestClient</argument>
            <argument name="validator" xsi:type="object">CitiHpfThreeDSecureResultValidator</argument>
            <argument name="handler" xsi:type="object">Citi\PayBySpring\Gateway\Response\ThreeDSecure\ResultHandler</argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfTransferFactoryProcess" type="Citi\PayBySpring\Gateway\Http\ThreeDSecure\TransferFactoryProcess">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfThreeDSecureResultValidator" type="Magento\Payment\Gateway\Validator\ValidatorComposite">
        <arguments>
            <argument name="validators" xsi:type="array">
                <item name="response" xsi:type="string">Citi\PayBySpring\Gateway\Validator\ThreeDSecureValidator</item>
                <item name="session" xsi:type="string">Citi\PayBySpring\Gateway\Validator\ThreeDSecure\ProcessValidator</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfAuthorizeDataBuilder" type="Magento\Payment\Gateway\Request\BuilderComposite">
        <arguments>
            <argument name="builders" xsi:type="array">
                <item name="operation" xsi:type="string">AuthorizeOperationDataBuilder</item>
                <item name="session" xsi:type="string">Citi\PayBySpring\Gateway\Request\Hpf\SessionDataBuilder</item>
                <item name="order" xsi:type="string">Citi\PayBySpring\Gateway\Request\OrderDataBuilder</item>
                <item name="authentication_transaction_id" xsi:type="string">Citi\PayBySpring\Gateway\Request\Authentication\AuthenticationTransactionIdBuilder</item>
                <item name="line_items" xsi:type="string">Citi\PayBySpring\Gateway\Request\LineItemsBuilder</item>
                <item name="discount" xsi:type="string">Citi\PayBySpring\Gateway\Request\DiscountBuilder</item>
                <item name="billing" xsi:type="string">Citi\PayBySpring\Gateway\Request\BillingDataBuilder</item>
                <item name="shipping" xsi:type="string">Citi\PayBySpring\Gateway\Request\ShippingDataBuilder</item>
                <item name="customer" xsi:type="string">Citi\PayBySpring\Gateway\Request\CustomerDataBuilder</item>
                <item name="3ds_results" xsi:type="string">CitiHpfThreeDSecureResultDataBuilder</item>
                <item name="source" xsi:type="string">Citi\PayBySpring\Gateway\Request\SourceDataBuilder</item>
                <item name="version" xsi:type="string">Citi\PayBySpring\Gateway\Request\VersionDataBuilder</item>
                <item name="extra" xsi:type="string">CitiHpfAuthorizeExtraDataBuilder</item>
                <item name="transaction_reference" xsi:type="string">Citi\PayBySpring\Gateway\Request\TransactionReferenceDataBuilder</item>
            </argument>
        </arguments>
    </virtualType>
    <virtualType name="CitiHpfAuthorizeExtraDataBuilder" type="Citi\PayBySpring\Gateway\Request\ExtraDataBuilder">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
            <argument name="field" xsi:type="string">custom_authorize_request_data</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfTransferFactory" type="Citi\PayBySpring\Gateway\Http\TransferFactory">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>

    <virtualType name="CitiHpfThreeDSecureResultDataBuilder" type="Citi\PayBySpring\Gateway\Request\ThreeDSecure\ResultsDataBuilder">
        <arguments>
            <argument name="config" xsi:type="object">CitiHpfConfig</argument>
        </arguments>
    </virtualType>

    <type name="Magento\Framework\Session\SessionManager">
        <plugin name="Citi_PayBySpring::Magento\Framework\Session\SessionManager::beforeStart" type="Citi\PayBySpring\Plugin\Magento\Framework\Session\SessionManagerPlugin" />
    </type>

    <type name="Citi\PayBySpring\Observer\ConfigSaveAfter">
        <arguments>
            <argument name="commandPool" xsi:type="object">MetaCommandPool</argument>
            <argument name="methods" xsi:type="array">
                <item name="citi_hpf" xsi:type="string">citi_hpf</item>
                <item name="citi_hosted" xsi:type="string">citi_hosted</item>
            </argument>
        </arguments>
    </type>

    <type name="Citi\PayBySpring\Controller\ThreedsecureV2\AuthenticatePayer">
        <arguments>
            <argument name="commandPool" xsi:type="object">CitiHpfCommandPool</argument>
            <argument name="logger" xsi:type="object">Magento\Payment\Model\Method\VirtualLogger</argument>
        </arguments>
    </type>

    <type name="Citi\PayBySpring\Controller\ThreedsecureV2\InitiateAuthentication">
        <arguments>
            <argument name="commandPool" xsi:type="object">CitiHpfCommandPool</argument>
            <argument name="logger" xsi:type="object">Magento\Payment\Model\Method\VirtualLogger</argument>
        </arguments>
    </type>
</config>
